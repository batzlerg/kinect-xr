<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kinect XR - Dashboard</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #4cc9f0; }
    .container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .panel {
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
      flex: 1;
      min-width: 300px;
    }
    .panel h2 {
      margin-top: 0;
      color: #7209b7;
    }
    canvas {
      border: 2px solid #4361ee;
      border-radius: 4px;
      max-width: 100%;
    }
    .stats {
      font-family: monospace;
      font-size: 12px;
      background: #0f0f23;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    button {
      background: #4361ee;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover { background: #3f37c9; }
    button:disabled { background: #555; cursor: not-allowed; }
    button.active { background: #2d6a4f; }
    button.led-off { background: #333; }
    button.led-green { background: #2d6a4f; }
    button.led-red { background: #9d0208; }
    button.led-yellow { background: #fca311; color: #000; }
    button.led-blink { background: linear-gradient(90deg, #2d6a4f, #333); animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.connected { background: #2d6a4f; }
    .status.disconnected { background: #6c1d3f; }
    .status.connecting { background: #5a4a00; }
    #depthCanvas { image-rendering: pixelated; }
    .motor-panel { display: flex; gap: 20px; flex-wrap: wrap; }
    .motor-section { flex: 1; min-width: 200px; }
    .motor-section h3 { margin: 0 0 10px 0; color: #4cc9f0; font-size: 14px; }
    .tilt-control { display: flex; align-items: center; gap: 15px; }
    .tilt-slider { flex: 1; height: 8px; -webkit-appearance: none; background: #333; border-radius: 4px; }
    .tilt-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #4361ee; border-radius: 50%; cursor: pointer; }
    .tilt-value { font-family: monospace; font-size: 18px; min-width: 60px; text-align: right; }
    .led-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .led-buttons button { padding: 8px 12px; font-size: 12px; }
    .accel-display { font-family: monospace; font-size: 12px; }
    .motor-status { padding: 8px; background: #0f0f23; border-radius: 4px; font-family: monospace; font-size: 12px; margin-top: 10px; }
    .back-link {
      display: inline-block;
      margin-bottom: 10px;
      color: #4cc9f0;
      text-decoration: none;
    }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <a href="/" class="back-link">&larr; Back to Examples</a>
  <h1>Kinect XR Dashboard</h1>

  <div class="status disconnected" id="status">Disconnected</div>

  <p>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
  </p>

  <div class="container">
    <div class="panel">
      <h2>RGB Video</h2>
      <canvas id="rgbCanvas" width="640" height="480"></canvas>
      <div class="stats" id="rgbStats">Waiting for frames...</div>
    </div>

    <div class="panel">
      <h2>Depth Map</h2>
      <canvas id="depthCanvas" width="640" height="480"></canvas>
      <div class="stats" id="depthStats">Waiting for frames...</div>
    </div>
  </div>

  <div class="panel" style="margin-top: 20px;">
    <h2>Motor Control</h2>
    <div class="motor-panel">
      <div class="motor-section">
        <h3>Tilt Angle</h3>
        <div class="tilt-control">
          <span>-27°</span>
          <input type="range" id="tiltSlider" class="tilt-slider" min="-27" max="27" value="0" disabled>
          <span>+27°</span>
          <span class="tilt-value" id="tiltValue">0°</span>
        </div>
        <p style="margin: 10px 0 0; font-size: 12px; color: #666;">
          <button id="resetTiltBtn" disabled style="padding: 5px 10px; font-size: 12px;">Reset to 0°</button>
        </p>
      </div>
      <div class="motor-section">
        <h3>LED State</h3>
        <div class="led-buttons">
          <button id="ledOff" class="led-off" disabled>Off</button>
          <button id="ledGreen" class="led-green" disabled>Green</button>
          <button id="ledRed" class="led-red" disabled>Red</button>
          <button id="ledYellow" class="led-yellow" disabled>Yellow</button>
          <button id="ledBlinkGreen" class="led-blink" disabled>Blink</button>
        </div>
      </div>
      <div class="motor-section">
        <h3>Accelerometer</h3>
        <div class="accel-display" id="accelDisplay">X: --  Y: --  Z: --</div>
      </div>
    </div>
    <div class="motor-status" id="motorStatus">Motor: Not connected</div>
  </div>

  <div class="panel" style="margin-top: 20px;">
    <h2>Connection Stats</h2>
    <div class="stats" id="connectionStats">Not connected</div>
  </div>

  <script type="module">
    import { KinectClient, KINECT } from '../../lib/kinect-client.js';

    const rgbCanvas = document.getElementById('rgbCanvas');
    const depthCanvas = document.getElementById('depthCanvas');
    const rgbCtx = rgbCanvas.getContext('2d');
    const depthCtx = depthCanvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const rgbStatsEl = document.getElementById('rgbStats');
    const depthStatsEl = document.getElementById('depthStats');
    const connectionStatsEl = document.getElementById('connectionStats');

    // Create depth visualization ImageData
    const depthImageData = depthCtx.createImageData(KINECT.WIDTH, KINECT.HEIGHT);

    // Create client
    const kinect = new KinectClient();

    // Frame timing
    let lastRgbTime = 0;
    let lastDepthTime = 0;
    let rgbFps = 0;
    let depthFps = 0;

    // RGB frame handler
    kinect.onRgbFrame = (imageData, frameId) => {
      rgbCtx.putImageData(imageData, 0, 0);

      const now = performance.now();
      if (lastRgbTime > 0) {
        rgbFps = 1000 / (now - lastRgbTime);
      }
      lastRgbTime = now;

      rgbStatsEl.textContent = `Frame: ${frameId} | FPS: ${rgbFps.toFixed(1)} | Total: ${kinect.stats.rgbFrames}`;
    };

    // Depth frame handler
    kinect.onDepthFrame = (depth, frameId) => {
      // Visualize depth as grayscale
      for (let i = 0; i < depth.length; i++) {
        const d = depth[i];
        // Map depth (800-4000mm) to grayscale (255-0)
        // Closer = brighter
        let gray = 0;
        if (d >= KINECT.MIN_DEPTH_MM && d <= KINECT.MAX_DEPTH_MM) {
          gray = 255 - Math.floor((d - KINECT.MIN_DEPTH_MM) / (KINECT.MAX_DEPTH_MM - KINECT.MIN_DEPTH_MM) * 255);
        }
        const idx = i * 4;
        depthImageData.data[idx] = gray;     // R
        depthImageData.data[idx + 1] = gray; // G
        depthImageData.data[idx + 2] = gray; // B
        depthImageData.data[idx + 3] = 255;  // A
      }
      depthCtx.putImageData(depthImageData, 0, 0);

      const now = performance.now();
      if (lastDepthTime > 0) {
        depthFps = 1000 / (now - lastDepthTime);
      }
      lastDepthTime = now;

      // Show center depth value
      const centerIdx = 320 + 240 * 640;
      const centerDepth = depth[centerIdx];
      depthStatsEl.textContent = `Frame: ${frameId} | FPS: ${depthFps.toFixed(1)} | Center: ${centerDepth}mm | Total: ${kinect.stats.depthFrames}`;
    };

    kinect.onConnect = (capabilities) => {
      statusEl.textContent = `Connected - ${capabilities.rgb.width}x${capabilities.rgb.height} @ ${capabilities.frame_rate_hz}Hz`;
      statusEl.className = 'status connected';
      connectBtn.disabled = true;
      disconnectBtn.disabled = false;
    };

    kinect.onDisconnect = () => {
      statusEl.textContent = 'Disconnected';
      statusEl.className = 'status disconnected';
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
    };

    kinect.onError = (error) => {
      console.error('Kinect error:', error);
      statusEl.textContent = `Error: ${error.message || error.code}`;
    };

    // Update connection stats periodically
    setInterval(() => {
      if (kinect.connected) {
        const stats = kinect.getStats();
        const mb = (stats.bytesReceived / (1024 * 1024)).toFixed(2);
        connectionStatsEl.textContent =
          `Received: ${mb} MB | ` +
          `RGB dropped: ${stats.droppedRgbFrames} | ` +
          `Depth dropped: ${stats.droppedDepthFrames}`;
      }
    }, 1000);

    // Button handlers
    connectBtn.onclick = async () => {
      statusEl.textContent = 'Connecting...';
      statusEl.className = 'status connecting';
      try {
        await kinect.connect();
      } catch (e) {
        statusEl.textContent = `Connection failed: ${e.message}`;
        statusEl.className = 'status disconnected';
      }
    };

    disconnectBtn.onclick = () => {
      kinect.disconnect();
    };

    // Motor Control
    const tiltSlider = document.getElementById('tiltSlider');
    const tiltValue = document.getElementById('tiltValue');
    const resetTiltBtn = document.getElementById('resetTiltBtn');
    const motorStatusEl = document.getElementById('motorStatus');
    const accelDisplay = document.getElementById('accelDisplay');
    const ledButtons = {
      off: document.getElementById('ledOff'),
      green: document.getElementById('ledGreen'),
      red: document.getElementById('ledRed'),
      yellow: document.getElementById('ledYellow'),
      blink_green: document.getElementById('ledBlinkGreen'),
    };

    let currentLED = 'off';
    let tiltTimeout = null;

    function enableMotorControls(enabled) {
      tiltSlider.disabled = !enabled;
      resetTiltBtn.disabled = !enabled;
      Object.values(ledButtons).forEach(btn => btn.disabled = !enabled);
    }

    function updateMotorStatus(status) {
      const angle = status.angle?.toFixed(1) ?? '--';
      const state = status.status ?? 'UNKNOWN';
      motorStatusEl.textContent = `Motor: ${angle}° | Status: ${state}`;

      // Update slider to match actual position
      if (status.angle !== undefined) {
        tiltSlider.value = status.angle;
        tiltValue.textContent = `${Math.round(status.angle)}°`;
      }

      // Update accelerometer display
      if (status.accelerometer) {
        const a = status.accelerometer;
        accelDisplay.textContent = `X: ${a.x?.toFixed(2) ?? '--'}  Y: ${a.y?.toFixed(2) ?? '--'}  Z: ${a.z?.toFixed(2) ?? '--'}`;
      }
    }

    // Motor status callback (streaming updates during movement)
    kinect.onMotorStatus = (status) => {
      updateMotorStatus(status);
    };

    kinect.onMotorError = (error) => {
      motorStatusEl.textContent = `Motor Error: ${error.code} - ${error.message}`;
    };

    // Update on connection
    const originalOnConnect = kinect.onConnect;
    kinect.onConnect = async (capabilities) => {
      originalOnConnect?.(capabilities);
      enableMotorControls(true);

      // Check if motor control is available
      if (capabilities.motor) {
        motorStatusEl.textContent = 'Motor: Querying status...';
        try {
          const status = await kinect.getMotorStatus();
          updateMotorStatus(status);
        } catch (e) {
          motorStatusEl.textContent = `Motor: ${e.message}`;
        }
      } else {
        motorStatusEl.textContent = 'Motor: Not supported by server';
      }
    };

    const originalOnDisconnect = kinect.onDisconnect;
    kinect.onDisconnect = () => {
      originalOnDisconnect?.();
      enableMotorControls(false);
      motorStatusEl.textContent = 'Motor: Not connected';
    };

    // Tilt slider - debounced to respect rate limiting
    tiltSlider.oninput = () => {
      const angle = parseInt(tiltSlider.value);
      tiltValue.textContent = `${angle}°`;

      // Debounce: wait for user to stop sliding
      clearTimeout(tiltTimeout);
      tiltTimeout = setTimeout(async () => {
        motorStatusEl.textContent = `Motor: Moving to ${angle}°...`;
        try {
          await kinect.setTilt(angle);
        } catch (e) {
          motorStatusEl.textContent = `Motor Error: ${e.message}`;
        }
      }, 100);
    };

    resetTiltBtn.onclick = async () => {
      motorStatusEl.textContent = 'Motor: Resetting to 0°...';
      try {
        await kinect.resetTilt();
        tiltSlider.value = 0;
        tiltValue.textContent = '0°';
      } catch (e) {
        motorStatusEl.textContent = `Motor Error: ${e.message}`;
      }
    };

    // LED buttons
    Object.entries(ledButtons).forEach(([state, btn]) => {
      btn.onclick = async () => {
        try {
          await kinect.setLED(state);
          // Update active state
          Object.values(ledButtons).forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentLED = state;
        } catch (e) {
          motorStatusEl.textContent = `LED Error: ${e.message}`;
        }
      };
    });
  </script>
</body>
</html>
